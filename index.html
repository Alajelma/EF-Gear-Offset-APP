<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Gear Offset 2050 – Verzahnung / Fanuc / OCR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QR-Generator -->


<!-- QR Scanner -->


<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root {
  --bg: #05060a;
  --panel: #0b1024cc;
  --accent: #4fd1ff;
  --text: #eef5ff;
  --muted: #9bb2cc;
  --border: #2a3558;
}
body {
  margin:0;
  background:radial-gradient(circle at top, #11172f 0%, #05060a 60%);
  color:var(--text);
  font-family:system-ui, sans-serif;
  padding:16px;
}
.card {
  background:var(--panel);
  backdrop-filter:blur(18px);
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
  border:1px solid var(--border);
  box-shadow:0 0 24px rgba(0,255,224,0.15);
}
h2 {
  margin:0 0 14px 0;
  text-transform:uppercase;
  font-size:15px;
  letter-spacing:0.18em;
  color:var(--accent);
}
label {
  color:var(--muted);
  font-size:12px;
}
input,select {
  width:100%;
  padding:7px 10px;
  border-radius:10px;
  border:1px solid #3a4a6b;
  background:#060917cc;
  color:var(--text);
  margin-bottom:8px;
}
button {
  padding:7px 14px;
  background:#0c1430cc;
  border:1px solid var(--accent);
  border-radius:14px;
  color:var(--text);
  letter-spacing:0.12em;
  font-size:11px;
  cursor:pointer;
}
pre {
  background:#060917dd;
  border-radius:10px;
  padding:12px;
  border:1px solid #3a4a6b;
  font-size:12px;
  white-space:pre-wrap;
}
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:18px; }
@media(max-width:900px){ .grid-2 { grid-template-columns:1fr; } }
.small-btn { font-size:10px; padding:5px 10px; }
#ocrPreview { max-width:100%; border-radius:10px; margin-top:10px; display:none; }
</style>
</head>

<body>
<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
  <img src="logo.jpg" alt="Logo" style="height:52px;border-radius:8px;">
  <div>
    <div style="color:#4fd1ff;font-size:15px;letter-spacing:0.14em;text-transform:uppercase;">
      Gear Offset Tool 2050
    </div>
    <div style="color:#9bb2cc;font-size:11px;">Verzahnung · OCR Analyse · Fanuc Wear · PDF · QR</div>
  </div>
</div>

<!-- QR für App -->


<div class="grid-2">

<!-- LINKER BEREICH -->
<div>

<!-- TEMPLATES -->
<div class="card">
<h2>Templates</h2>

<label>Vorlage</label>
<select id="templateSelect"></select>

<button class="small-btn" onclick="loadTemplate()">Laden</button>
<button class="small-btn" onclick="deleteTemplate()">Loeschen</button>

<hr style="border-color:#2a3558;margin:14px 0;">

<label>Template speichern als</label>
<input id="tplName" placeholder="z. B. Modul_1_55grad">
<button class="small-btn" onclick="saveTemplate()">Speichern</button>
</div>

<!-- SOLLWERTE -->
<div class="card">
<h2>Sollwerte</h2>

<div class="grid-2">
  <div>
    <label>Z1 Pferch Soll</label>
    <input id="z1P_soll" type="number" step="0.001">
  </div>
  <div>
    <label>Z1 Huell Soll</label>
    <input id="z1H_soll" type="number" step="0.001">
  </div>
  <div>
    <label>Z2 Pferch Soll</label>
    <input id="z2P_soll" type="number" step="0.001">
  </div>
  <div>
    <label>Z2 Huell Soll</label>
    <input id="z2H_soll" type="number" step="0.001">
  </div>
</div>

<div class="grid-2">
  <div>
    <label>Z1 Position</label>
    <input id="z1_pos" type="number" step="0.001" placeholder="0.000">
  </div>
  <div>
    <label>Z2 Position</label>
    <input id="z2_pos" type="number" step="0.001" placeholder="10.000">
  </div>
</div>

<label>Fräserwinkel (Grad)</label>
<input id="winkel" type="number" step="0.1" value="55">

</div>

<!-- ISTWERTE / OCR -->
<div class="card">
<h2>Istwerte · OCR</h2>

<div class="grid-2">
  <div><label>Z1 Pferch Ist</label><input id="z1P_ist" type="number"></div>
  <div><label>Z1 Huell Ist</label><input id="z1H_ist" type="number"></div>
  <div><label>Z2 Pferch Ist</label><input id="z2P_ist" type="number"></div>
  <div><label>Z2 Huell Ist</label><input id="z2H_ist" type="number"></div>
</div>

<input id="ocrFile" type="file" accept="image/*">
<button class="small-btn" onclick="runOCR()">OCR starten</button>

<img id="ocrPreview">
<div id="ocrStatus" style="font-size:11px;color:#9bb2cc;margin-top:6px;"></div>
</div>

</div>

<!-- RECHTE SEITE -->
<div>

<!-- BERECHNUNG -->
<div class="card">
<h2>Berechnung X / Z / Y</h2>
<button onclick="calculate()">Berechnen</button>
<button class="small-btn" onclick="exportPDF()">PDF exportieren</button>
<pre id="result">Noch keine Berechnung</pre>
</div>

<!-- FANUC -->
<div class="card">
<h2>Fanuc Wear Korrektur</h2>
<pre id="fanucOut">Noch keine Daten</pre>
</div>

<!-- QR DATEN-SCANNER -->

</div>

</div>
</div>


<script>
// --------------------------
// Template Verwaltung
// --------------------------
function refreshTemplates() {
  const sel = document.getElementById("templateSelect");
  sel.innerHTML = "";
  Object.keys(localStorage).filter(k => k.startsWith("gear_tpl_"))
    .forEach(k => {
      const op = document.createElement("option");
      op.value = k;
      op.textContent = k.replace("gear_tpl_","");
      sel.appendChild(op);
    });
}
refreshTemplates();

function saveTemplate() {
  const name = document.getElementById("tplName").value.trim();
  if(!name){ alert("Name fehlt"); return; }

  const data = {
    z1P_soll: z1P_soll.value,
    z1H_soll: z1H_soll.value,
    z2P_soll: z2P_soll.value,
    z2H_soll: z2H_soll.value,
    z1_pos: z1_pos.value,
    z2_pos: z2_pos.value,
    winkel: winkel.value
  };
  localStorage.setItem("gear_tpl_"+name, JSON.stringify(data));
  refreshTemplates();
  alert("Gespeichert");
}

function loadTemplate() {
  const key = document.getElementById("templateSelect").value;
  if(!key) return;
  const data = JSON.parse(localStorage.getItem(key));
  Object.keys(data).forEach(k => document.getElementById(k).value = data[k]);
  alert("Template geladen");
}

function deleteTemplate() {
  const key = document.getElementById("templateSelect").value;
  if(!key) return;
  localStorage.removeItem(key);
  refreshTemplates();
}

// --------------------------
// QR für App-URL
// --------------------------


  const canvas = document.getElementById("qrAppCanvas");
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,200,200);

  QRCode.toCanvas(canvas, url, {margin:1,scale:6});

  const logo = document.querySelector("img[src='logo.jpg']");
  if(logo.complete) drawLogoOnQR(canvas,logo);
  else logo.onload = ()=>drawLogoOnQR(canvas,logo);
}



// --------------------------
// OCR
// --------------------------
async function runOCR(){
  const fi = document.getElementById("ocrFile");
  if(!fi.files[0]){ alert("Bild fehlt"); return; }

  document.getElementById("ocrStatus").textContent="Erkenne Text...";
  const img = fi.files[0];
  const reader = new FileReader();
  reader.onload = async()=>{
    const preview=document.getElementById("ocrPreview");
    preview.src=reader.result;
    preview.style.display="block";

    const {data:{text}} = await Tesseract.recognize(reader.result,"deu");
    parseOCR(text);
  };
  reader.readAsDataURL(img);
}

// Pferch / Huell Werte erkennen
function parseOCR(text){
  const lines = text.split(/\n/).map(l=>l.trim());
  const found = {Z1P:null,Z1H:null,Z2P:null,Z2H:null};

  lines.forEach(line=>{
    if(!/Pferch|Huell/.test(line)) return;
    const match = line.match(/(\d{2}\.\d{3})/g);
    if(!match) return;
    const val = parseFloat(match[match.length-1]);

    const id = line.match(/^(\d+)_/);
    const nr = id ? parseInt(id[1]) : null;

    if(nr==1) if(/Pferch/.test(line)) found.Z1P = val;
    if(nr==2) if(/Huell/.test(line))  found.Z1H = val;
    if(nr==3) if(/Pferch/.test(line)) found.Z2P = val;
    if(nr==4) if(/Huell/.test(line))  found.Z2H = val;
  });

  if(found.Z1P) z1P_ist.value = found.Z1P;
  if(found.Z1H) z1H_ist.value = found.Z1H;
  if(found.Z2P) z2P_ist.value = found.Z2P;
  if(found.Z2H) z2H_ist.value = found.Z2H;

  document.getElementById("ocrStatus").textContent="OCR abgeschlossen";
}

// --------------------------
// Berechnung
// --------------------------
function calculate(){
  const f=id=>parseFloat(document.getElementById(id).value);

  const z1P_s=f("z1P_soll"), z1H_s=f("z1H_soll");
  const z2P_s=f("z2P_soll"), z2H_s=f("z2H_soll");

  const z1P_i=f("z1P_ist"), z1H_i=f("z1H_ist");
  const z2P_i=f("z2P_ist"), z2H_i=f("z2H_ist");

  const Z1=f("z1_pos"), Z2=f("z2_pos");
  const W=f("winkel");

  const D1_s=(z1P_s+z1H_s)/2;
  const D2_s=(z2P_s+z2H_s)/2;

  const D1_i=(z1P_i+z1H_i)/2;
  const D2_i=(z2P_i+z2H_i)/2;

  const dD1=D1_i-D1_s;
  const dD2=D2_i-D2_s;

  const dMean=(dD1+dD2)/2;
  const dDiff=dD2-dD1;

  const L=Math.abs(Z2-Z1);
  const rad=W*Math.PI/180;

  const offX = -dMean/2;
  const offZ = -dDiff/(2*Math.tan(rad));

  const pair1_s=z1H_s - z1P_s;
  const pair2_s=z2H_s - z2P_s;

  const pair1_i=z1H_i - z1P_i;
  const pair2_i=z2H_i - z2P_i;

  const dPair1=pair1_i-pair1_s;
  const dPair2=pair2_i-pair2_s;

  const dPairMean=(dPair1+dPair2)/2;

  let offY=0;
  let yInfo="Y scheint ok.";
  if(Math.abs(dPairMean)>0.01){
    offY = -dPairMean/2;
    yInfo = dPairMean>0 ? 
      "Huell weiter → Y korrigieren +" : 
      "Huell näher → Y korrigieren -";
  }

  const txt =
    "Schnitt Z1 Mittel: Ist "+D1_i.toFixed(3)+" · Soll "+D1_s.toFixed(3)+" → Δ "+dD1.toFixed(3)+"\n"+
    "Schnitt Z2 Mittel: Ist "+D2_i.toFixed(3)+" · Soll "+D2_s.toFixed(3)+" → Δ "+dD2.toFixed(3)+"\n\n"+
    "ΔDmittel = "+dMean.toFixed(3)+"\n"+
    "ΔDdiff   = "+dDiff.toFixed(3)+"\n"+
    "L = "+L.toFixed(3)+" mm\n\n"+
    "X Offset: "+offX.toFixed(3)+" mm\n"+
    "Z Offset: "+offZ.toFixed(3)+" mm\n\n"+
    "Pferch/Huell Differenz Z1: "+pair1_i.toFixed(3)+" (Soll "+pair1_s.toFixed(3)+")\n"+
    "Pferch/Huell Differenz Z2: "+pair2_i.toFixed(3)+" (Soll "+pair2_s.toFixed(3)+")\n"+
    "Δ Mittel: "+dPairMean.toFixed(3)+"\n\n"+
    "Y Empfehlung: "+offY.toFixed(3)+" mm\n"+
    "Kommentar: "+yInfo;

  document.getElementById("result").textContent = txt;

  const fan =
    "FANUC WEAR\n"+
    "------------------\n"+
    "X: "+offX.toFixed(3)+" mm\n"+
    "Z: "+offZ.toFixed(3)+" mm\n"+
    "Y (optional): "+offY.toFixed(3)+" mm\n\n"+
    "Winkel: "+W.toFixed(1)+"°";

  document.getElementById("fanucOut").textContent = fan;

  window._pdfData = {txt,fan};
}

// --------------------------
// PDF
// --------------------------
function exportPDF(){
  const {jsPDF} = window.jspdf;
  const doc = new jsPDF();
  const logo = document.querySelector("img[src='logo.jpg']");

  try{
    const c=document.createElement("canvas");
    c.width=logo.naturalWidth;
    c.height=logo.naturalHeight;
    const ctx=c.getContext("2d");
    ctx.drawImage(logo,0,0);
    const data=c.toDataURL("image/png");
    doc.addImage(data,"PNG",10,8,35,12);
  }catch(e){}

  doc.setFontSize(12);
  doc.text("Gear Offset Tool 2050 – Report",10,28);
  doc.setFontSize(9);
  doc.text("Datum: "+new Date().toLocaleString(),10,34);

  const res=window._pdfData?.txt || "";
  const fan=window._pdfData?.fan || "";

  doc.text("Berechnung:",10,44);
  doc.setFont("courier","normal");
  doc.text(res.split("\n"),10,50);

  const y = 50 + res.split("\n").length*4 + 6;
  doc.setFont("helvetica","normal");
  doc.text("Fanuc:",10,y);
  doc.setFont("courier","normal");
  doc.text(fan.split("\n"),10,y+6);

  doc.save("gear-offset-report.pdf");
}

// --------------------------
// QR Scanner Messdaten
// --------------------------
,
    {fps:10,qrbox:200},
    decoded=>{
      try{
        const d=JSON.parse(decoded);
        if(d.z1P_ist) z1P_ist.value=d.z1P_ist;
        if(d.z1H_ist) z1H_ist.value=d.z1H_ist;
        if(d.z2P_ist) z2P_ist.value=d.z2P_ist;
        if(d.z2H_ist) z2H_ist.value=d.z2H_ist;
        alert("QR geladen");
      }catch(e){ alert("Kein gültiges JSON"); }
      qr.stop();
      div.style.display="none";
    }
  );
}
</script>

</body>
</html>
