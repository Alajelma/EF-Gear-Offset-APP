<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Gear Offset 2050 – Lernende Verzahnungs-Korrektur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root {
  --bg: #05060a;
  --panel: #0b1024cc;
  --accent: #4fd1ff;
  --text: #eef5ff;
  --muted: #9bb2cc;
  --border: #2a3558;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:radial-gradient(circle at top,#11172f,#05060a 60%);
  color:var(--text);
  font-family:-apple-system,system-ui,Segoe UI,sans-serif;
  padding:10px;
}
.app{
  max-width:1200px;
  margin:0 auto;
}
.card{
  background:var(--panel);
  padding:12px;
  border-radius:14px;
  margin-bottom:12px;
  border:1px solid var(--border);
  backdrop-filter:blur(16px);
}
h2{
  margin:0 0 8px 0;
  color:var(--accent);
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:0.16em;
}
label{
  color:var(--muted);
  font-size:11px;
  display:block;
  margin-bottom:2px;
}
input,textarea,select{
  width:100%;
  padding:5px 8px;
  border-radius:8px;
  border:1px solid #3a4a6b;
  background:#060917cc;
  color:var(--text);
  margin-bottom:6px;
  font-size:12px;
}
button{
  padding:5px 10px;
  border-radius:10px;
  border:1px solid var(--accent);
  background:#0c1430cc;
  color:var(--text);
  font-size:10px;
  letter-spacing:0.10em;
  text-transform:uppercase;
  cursor:pointer;
}
button.secondary{
  border-color:#3a4a6b;
  background:#080d1bcc;
}
button.y-off{
  border-color:#ff4b6a;
  color:#ff4b6a;
  background:#14060acc;
}
button.y-on{
  border-color:#32d675;
  color:#32d675;
  background:#05150bcc;
}
button.y-active{
  box-shadow:0 0 10px rgba(50,214,117,0.6);
}
.grid-main{
  display:grid;
  grid-template-columns:1.2fr 1fr;
  gap:10px;
}
.grid-2-small{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.grid-4-small{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
}
pre{
  background:#060917dd;
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
  white-space:pre-wrap;
  font-size:11px;
  margin:0;
}
.orange{
  color:#ffb347;
  font-weight:bold;
}
#qrcode{
  width:260px;
  height:260px;
  display:flex;
  justify-content:center;
  align-items:center;
  margin-top:8px;
}
.info{
  font-size:10px;
  color:var(--muted);
  margin-top:4px;
}
.header{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}
.header img{
  height:44px;
  border-radius:8px;
}
.header-title{
  color:var(--accent);
  font-size:14px;
  letter-spacing:0.14em;
  text-transform:uppercase;
}
.header-sub{
  color:var(--muted);
  font-size:10px;
}
@media(max-width:900px){
  .grid-main{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="app">

<div class="header">
  <img src="logo.jpg" alt="Logo">
  <div>
    <div class="header-title">Gear Offset 2050</div>
    <div class="header-sub">Verzahnung • Lernende Fanuc-Korrektur • DFQ • PDF</div>
  </div>
</div>

<div class="grid-main">

<div>

  <div class="card">
    <h2>Stammdaten & Templates</h2>

    <div class="grid-2-small">
      <div><label>Artikel</label><input id="article_id"></div>
      <div><label>Maschine</label><input id="machine_id"></div>
    </div>

    <div class="grid-2-small">
      <div><label>Template Auswahl</label><select id="templateSelect"></select></div>
      <div><label>Name speichern</label><input id="tplName"></div>
    </div>

    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;">
      <button class="secondary" onclick="saveTemplate()">Speichern</button>
      <button class="secondary" onclick="loadTemplate()">Laden</button>
      <button class="secondary" onclick="deleteTemplate()">Loeschen</button>
    </div>

    <textarea id="tplJson" rows="2"></textarea>
  </div>

  <div class="card">
    <h2>Soll / Ist</h2>

    <div class="grid-4-small">
      <div><label>Z1 Pferch Soll</label><input id="z1P_soll"></div>
      <div><label>Z1 Huell Soll</label><input id="z1H_soll"></div>
      <div><label>Z2 Pferch Soll</label><input id="z2P_soll"></div>
      <div><label>Z2 Huell Soll</label><input id="z2H_soll"></div>
    </div>

    <div class="grid-4-small">
      <div><label>Z1 Pferch Ist</label><input id="z1P_ist"></div>
      <div><label>Z1 Huell Ist</label><input id="z1H_ist"></div>
      <div><label>Z2 Pferch Ist</label><input id="z2P_ist"></div>
      <div><label>Z2 Huell Ist</label><input id="z2H_ist"></div>
    </div>

    <div class="grid-2-small">
      <div><label>Z1 Position</label><input id="z1_pos"></div>
      <div><label>Z2 Position</label><input id="z2_pos"></div>
    </div>

    <div class="grid-2-small">
      <div><label>Fraeserwinkel</label><input id="winkel" value="55"></div>
      <div>
        <label>Y-Modus</label>
        <div style="display:flex;gap:4px;">
          <button id="yOffBtn" class="y-off y-active" onclick="setYMode(false)">Y AUS</button>
          <button id="yOnBtn" class="y-on" onclick="setYMode(true)">Y EIN</button>
        </div>
        <input id="y_enable" type="hidden" value="0">
      </div>
    </div>

    <div class="grid-2-small">
      <div><label>Y Standard</label><input id="offsetY_std"></div>
      <div><label>Vorschlag</label><div id="yStdSuggest" class="orange"></div></div>
    </div>
  </div>

  <div class="card">
    <h2>DFQ</h2>
    <div class="grid-2-small">
      <div><input id="dfqFile" type="file" accept=".dfq,.txt"></div>
      <div style="display:flex;align-items:flex-end;"><button class="secondary" onclick="parseDFQ()">DFQ laden</button></div>
    </div>
  </div>

  <div class="card">
    <h2>Lernen</h2>

    <div class="grid-2-small">
      <div><label>Korr X</label><input id="learn_x"></div>
      <div><label>Korr Y</label><input id="learn_y"></div>
    </div>

    <div class="grid-2-small">
      <div><label>Korr Z</label><input id="learn_z"></div>
      <div></div>
    </div>

    <div style="display:flex;gap:6px;">
      <button class="secondary" onclick="saveLearnStart()">Start speichern</button>
      <button class="secondary" onclick="applyLearning()">Lernen</button>
    </div>

    <div id="factorStatus" class="info"></div>
  </div>

</div>

<div>

  <div class="card">
    <h2>Berechnung</h2>
    <div style="display:flex;gap:6px;margin-bottom:6px;">
      <button onclick="calculate(false)">Berechnen</button>
      <button class="secondary" onclick="exportPDF()">PDF</button>
    </div>
    <pre id="result">Noch keine Berechnung</pre>
  </div>

  <div class="card">
    <h2>Fanuc Wear</h2>
    <pre id="fanucOut">Noch keine Daten</pre>
  </div>

</div>

</div>

<script>
function F(id){
  const el=document.getElementById(id);
  if(!el) return 0;
  const raw=(el.value||"").toString().replace(",",".");
  const v=parseFloat(raw);
  return isNaN(v)?0:v;
}

function refreshTemplateList(){
  templateSelect.innerHTML="";
  const keys=Object.keys(localStorage).filter(k=>k.startsWith("tpl_"));
  if(keys.length===0){
    const opt=document.createElement("option");
    opt.textContent="Kein Template";
    templateSelect.appendChild(opt);
    return;
  }
  keys.forEach(k=>{
    const d=JSON.parse(localStorage.getItem(k));
    const opt=document.createElement("option");
    opt.value=k;
    opt.textContent=(d.machine_id||"?")+" | "+(d.article_id||k.replace("tpl_",""));
    templateSelect.appendChild(opt);
  });
}
refreshTemplateList();

function saveTemplate(){
  const name=tplName.value.trim();
  if(!name)return;
  const d={
    article_id:article_id.value,
    machine_id:machine_id.value,
    z1P_soll:z1P_soll.value,
    z1H_soll:z1H_soll.value,
    z2P_soll:z2P_soll.value,
    z2H_soll:z2H_soll.value,
    z1_pos:z1_pos.value,
    z2_pos:z2_pos.value,
    winkel:winkel.value,
    y_enable:y_enable.value,
    offsetY_std:offsetY_std.value
  };
  localStorage.setItem("tpl_"+name,JSON.stringify(d));
  refreshTemplateList();
}

function loadTemplate(){
  const key=templateSelect.value;
  if(!key.startsWith("tpl_"))return;
  const d=JSON.parse(localStorage.getItem(key));
  Object.keys(d).forEach(k=>{
    const el=document.getElementById(k);
    if(!el)return;
    if(k==="y_enable"){setYMode(d[k]=="1");}
    else el.value=d[k];
  });
  saveYStd(F("offsetY_std"));
}

function deleteTemplate(){
  const key=templateSelect.value;
  if(key.startsWith("tpl_")){
    localStorage.removeItem(key);
    refreshTemplateList();
  }
}

function saveLearnStart(){
  learnStart={
    z1Ps:F("z1P_soll"), z1Hs:F("z1H_soll"),
    z2Ps:F("z2P_soll"), z2Hs:F("z2H_soll"),
    z1Pi:F("z1P_ist"), z1Hi:F("z1H_ist"),
    z2Pi:F("z2P_ist"), z2Hi:F("z2H_ist")
  };
  factorStatus.textContent="Start gespeichert";
}

function applyLearning(){
  if(!learnStart)return;
  const lx=F("learn_x"), ly=F("learn_y"), lz=F("learn_z");
  const s=learnStart;
  const D1s=(s.z1Ps+s.z1Hs)/2, D2s=(s.z2Ps+s.z2Hs)/2;
  const D1i=(s.z1Pi+s.z1Hi)/2, D2i=(s.z2Pi+s.z2Hi)/2;
  const dMean=((D1i-D1s)+(D2i-D2s))/2;
  const dDiff=(D2i-D2s)-(D1i-D1s);
  const pair2Ist=s.z2Hi-s.z2Pi;
  const pair2Soll=s.z2Hs-s.z2Ps;
  const dPair=pair2Ist-pair2Soll;
  const key=getModelKey();
  let arr=loadSamples(key);
  arr.push({dMean:dMean,dDiff:dDiff,dPair:dPair,offX:lx,offY:ly,offZ:lz});
  saveSamples(key,arr);
  factorStatus.textContent="gelernt";
}

function getModelKey(){
  const m=(machine_id.value||"").trim();
  const a=(article_id.value||"").trim();
  if(!m&&!a)return"global";
  return m+"|"+a;
}

function loadSamples(key){
  try{
    const s=localStorage.getItem("samples_"+key);
    if(!s)return[];
    return JSON.parse(s);
  }catch(e){return[];}
}

function saveSamples(key,arr){
  if(arr.length>300)arr=arr.slice(arr.length-300);
  localStorage.setItem("samples_"+key,JSON.stringify(arr));
}

function gaussGain(s,cMean,cDiff,cPair,axis){
  if(s.length===0)return null;
  const sm=0.03,sd=0.03,sp=0.03;
  const iM=1/(sm*sm), iD=1/(sd*sd), iP=1/(sp*sp);
  let s1=0,s2=0;
  for(const v of s){
    const dm=cMean-(v.dMean||0);
    const dd=cDiff-(v.dDiff||0);
    const dp=cPair-(v.dPair||0);
    const w=Math.exp(-0.5*(dm*dm*iM+dd*dd*iD+dp*dp*iP));
    let x,y;
    if(axis==="X"){x=v.dMean||0; y=v.offX||0;}
    else if(axis==="Z"){x=(v.dMean||0)+(v.dDiff||0); y=v.offZ||0;}
    else{x=v.dPair||0; y=v.offY||0;}
    s1+=w*x*x; s2+=w*x*y;
  }
  if(Math.abs(s1)<1e-6)return null;
  return s2/s1;
}

function setYMode(on){
  const b1=yOffBtn, b2=yOnBtn;
  y_enable.value=on?"1":"0";
  if(on){
    b2.classList.add("y-active");
    b1.classList.remove("y-active");
  }else{
    b1.classList.add("y-active");
    b2.classList.remove("y-active");
  }
}

function loadYStd(){
  const v=localStorage.getItem("offsetYStd");
  return v?parseFloat(v):0;
}
function saveYStd(v){
  localStorage.setItem("offsetYStd",v.toString());
}

function parseDFQ(){
  const f=dfqFile.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    const L=r.result.split(/\r?\n/);
    const v={};
    L.forEach(l=>{
      const m=l.match(/K0001\/(\d+)\s+([\d\.]+)/);
      if(m)v[m[1]]=parseFloat(m[2]);
    });
    if(v["1"]!=null)z1P_ist.value=v["1"].toFixed(3);
    if(v["2"]!=null)z1H_ist.value=v["2"].toFixed(3);
    if(v["3"]!=null)z2P_ist.value=v["3"].toFixed(3);
    if(v["4"]!=null)z2H_ist.value=v["4"].toFixed(3);
    calculate(true);
  };
  r.readAsText(f);
}

function calculate(force){
  const z1Ps=F("z1P_soll"), z1Hs=F("z1H_soll");
  const z2Ps=F("z2P_soll"), z2Hs=F("z2H_soll");
  const z1Pi=F("z1P_ist"), z1Hi=F("z1H_ist");
  const z2Pi=F("z2P_ist"), z2Hi=F("z2H_ist");

  const D1s=(z1Ps+z1Hs)/2, D2s=(z2Ps+z2Hs)/2;
  const D1i=(z1Pi+z1Hi)/2, D2i=(z2Pi+z2Hi)/2;

  const dD1=D1i-D1s;
  const dD2=D2i-D2s;

  const dMean=(dD1+dD2)/2;
  const dDiff=dD2-dD1;

  const pair2Ist=z2Hi-z2Pi;
  const pair2Soll=z2Hs-z2Ps;
  const dPair=pair2Ist-pair2Soll;

  const w=F("winkel")*(Math.PI/180);
  const tanw=Math.tan(w), cosw=Math.cos(w);
  const ZD=5.55;
  const wirkX=(1/cosw)*(1+tanw*ZD);

  const yEnabled=y_enable.value==="1";

  let ys=F("offsetY_std");
  if(isNaN(ys))ys=0;
  saveYStd(ys);
  offsetY_std.value=ys.toFixed(3);

  const featX=dMean;
  const featZ=dMean+dDiff;
  const featY=dPair;

  const key=getModelKey();
  const s=loadSamples(key);

  const baseX=wirkX;
  const baseZ=0.6;
  const baseY=0.7;

  function sugg(feat,ax,base){
    if(ax==="Y"&&!yEnabled)return 0;
    let g=s.length>0?gaussGain(s,dMean,dDiff,dPair,ax):null;
    if(g==null)g=base;
    return g*feat;
  }

  let oX=sugg(featX,"X",baseX);
  let oZ=sugg(featZ,"Z",baseZ);
  let oY=sugg(featY,"Y",baseY);

  if(!isFinite(oZ)){
    oZ=Math.abs(tanw)>1e-6?-(dDiff/(2*tanw)):0;
  }

  function clean(v){
    v=Math.round(v*100)/100;
    return Math.abs(v)<0.002?0:v;
  }
  oX=clean(oX); oY=clean(oY); oZ=clean(oZ);

  if(yEnabled&&oY!==0)yStdSuggest.textContent=oY.toFixed(2)+" mm";
  else yStdSuggest.textContent="";

  let uX,uZ,uY=ys;

  if(force){
    learn_x.value=oX.toFixed(2);
    learn_z.value=oZ.toFixed(2);
    uX=oX; uZ=oZ;
  }else{
    if(learn_x.value.trim()===""){learn_x.value=oX.toFixed(2); uX=oX;}
    else{uX=clean(F("learn_x")); learn_x.value=uX.toFixed(2);}
    if(learn_z.value.trim()===""){learn_z.value=oZ.toFixed(2); uZ=oZ;}
    else{uZ=clean(F("learn_z")); learn_z.value=uZ.toFixed(2);}
  }

  result.textContent=
    "ΔD1: "+dD1.toFixed(3)+" mm\n"+
    "ΔD2: "+dD2.toFixed(3)+" mm\n"+
    "ΔDmean: "+dMean.toFixed(3)+" mm\n"+
    "ΔDiff: "+dDiff.toFixed(3)+" mm\n"+
    "ΔPair2: "+dPair.toFixed(3)+" mm\n\n"+
    "Offsets:\n"+
    "X: "+uX.toFixed(2)+" mm\n"+
    "Z: "+uZ.toFixed(2)+" mm\n"+
    "Y: "+uY.toFixed(2)+" mm";

  fanucOut.textContent=
    "FANUC WEAR\n"+
    "X: "+uX.toFixed(2)+" mm\n"+
    "Z: "+uZ.toFixed(2)+" mm\n"+
    "Y: "+uY.toFixed(2)+" mm";
}

function exportPDF(){
  var doc=new jsPDF();

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("Gear Offset – Messbericht",10,14);

  doc.setFont("helvetica","normal");
  doc.setFontSize(9);
  doc.text("Datum: "+new Date().toLocaleString(),10,20);
  if(article_id.value)doc.text("Artikel: "+article_id.value,10,26);
  if(machine_id.value)doc.text("Maschine: "+machine_id.value,10,32);

  doc.setFont("helvetica","bold");
  doc.setFontSize(11);
  doc.text("Soll / Ist",10,40);
  doc.line(10,42,200,42);

  let y=48;
  function row(t,s,i){
    doc.text((t||"")+" "+(s||"-")+"  "+(i||"-"),10,y);
    y+=5;
  }
  row("Z1 Pferch",z1P_soll.value,z1P_ist.value);
  row("Z1 Huell",z1H_soll.value,z1H_ist.value);
  row("Z2 Pferch",z2P_soll.value,z2P_ist.value);
  row("Z2 Huell",z2H_soll.value,z2H_ist.value);

  doc.setFont("helvetica","bold");
  doc.setFontSize(11);
  doc.text("Offsets",10,y+6);
  doc.line(10,y+8,200,y+8);
  y+=14;

  doc.setFont("courier","normal");
  result.textContent.split("\n").forEach(l=>{
    doc.text(l,10,y); y+=5;
  });

  // Offsets für QR lesen
  const offX = F("learn_x");
  const offZ = F("learn_z");
  const offY = F("offsetY_std");

  const qrText =
    "Gear Offset 2050\n"+
    "Artikel: "+(article_id.value||"-")+"\n"+
    "Maschine: "+(machine_id.value||"-")+"\n"+
    "X: "+offX.toFixed(2)+" mm\n"+
    "Z: "+offZ.toFixed(2)+" mm\n"+
    "Y: "+offY.toFixed(2)+" mm";

  // QR-Code temporär erzeugen
  const qrTemp = document.createElement("div");
  new QRCode(qrTemp,{
    text: qrText,
    width:180,
    height:180,
    correctLevel:QRCode.CorrectLevel.H
  });

  let qrData=null;
  const img=qrTemp.querySelector("img");
  if(img && img.src){
    qrData=img.src;
  }else{
    const canvas=qrTemp.querySelector("canvas");
    if(canvas) qrData=canvas.toDataURL("image/png");
  }

  if(qrData){
    doc.setFont("helvetica","normal");
    doc.setFontSize(8);
    doc.text("QR scannen um Offsets auf dem Handy zu sehen", 120, 235);
    doc.addImage(qrData,"PNG",150,240,40,40);
  }

  doc.save("gear-offset.pdf");
}

window.addEventListener("load",()=>{
  const ys=loadYStd();
  offsetY_std.value=ys.toFixed(3);
});
</script>

</body>
</html>
