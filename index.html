<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Gear Offset 2050 – Lernende Verzahnungs-Korrektur</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script>

<style>
:root {
  --bg: #05060a;
  --panel: #0b1024cc;
  --accent: #4fd1ff;
  --text: #eef5ff;
  --muted: #9bb2cc;
  --border: #2a3558;
}
*{box-sizing:border-box;}
body{
  margin:0;
  background:radial-gradient(circle at top,#11172f,#05060a 60%);
  color:var(--text);
  font-family:-apple-system,system-ui,Segoe UI,sans-serif;
  padding:10px;
}
.app{
  max-width:1200px;
  margin:0 auto;
}
.card{
  background:var(--panel);
  padding:12px;
  border-radius:14px;
  margin-bottom:12px;
  border:1px solid var(--border);
  backdrop-filter:blur(16px);
}
h2{
  margin:0 0 8px 0;
  color:var(--accent);
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:0.16em;
}
label{
  color:var(--muted);
  font-size:11px;
  display:block;
  margin-bottom:2px;
}
input,textarea,select{
  width:100%;
  padding:5px 8px;
  border-radius:8px;
  border:1px solid #3a4a6b;
  background:#060917cc;
  color:var(--text);
  margin-bottom:6px;
  font-size:12px;
}
button{
  padding:5px 10px;
  border-radius:10px;
  border:1px solid var(--accent);
  background:#0c1430cc;
  color:var(--text);
  font-size:10px;
  letter-spacing:0.10em;
  text-transform:uppercase;
  cursor:pointer;
}
button.secondary{
  border-color:#3a4a6b;
  background:#080d1bcc;
}
button.y-off{
  border-color:#ff4b6a;
  color:#ff4b6a;
  background:#14060acc;
}
button.y-on{
  border-color:#32d675;
  color:#32d675;
  background:#05150bcc;
}
button.y-active{
  box-shadow:0 0 10px rgba(50,214,117,0.6);
}
.grid-main{
  display:grid;
  grid-template-columns:1.2fr 1fr;
  gap:10px;
}
.grid-2-small{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.grid-4-small{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
}
pre{
  background:#060917dd;
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
  white-space:pre-wrap;
  font-size:11px;
  margin:0;
}
.info{
  font-size:10px;
  color:var(--muted);
  margin-top:3px;
}
.header{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}
.header img{
  height:44px;
  border-radius:8px;
}
.header-title{
  color:var(--accent);
  font-size:14px;
  letter-spacing:0.14em;
  text-transform:uppercase;
}
.header-sub{
  color:var(--muted);
  font-size:10px;
}
@media(max-width:900px){
  .grid-main{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div class="app">

<!-- HEADER -->
<div class="header">
  <img src="logo.jpg" alt="Logo">
  <div>
    <div class="header-title">Gear Offset 2050</div>
    <div class="header-sub">Verzahnung • Lernende Fanuc-Korrektur • DFQ • PDF</div>
  </div>
</div>

<div class="grid-main">

<!-- LINKE SEITE -->
<div>

  <div class="card">
    <h2>Stammdaten & Templates</h2>

    <div class="grid-2-small">
      <div>
        <label>Artikel</label>
        <input id="article_id">
      </div>
      <div>
        <label>Maschine</label>
        <input id="machine_id">
      </div>
    </div>

    <div class="grid-2-small">
      <div>
        <label>Template Auswahl</label>
        <select id="templateSelect"></select>
      </div>
      <div>
        <label>Name speichern</label>
        <input id="tplName" placeholder="z.B. MHR_14042_M1">
      </div>
    </div>

    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;">
      <button class="secondary" onclick="saveTemplate()">Speichern</button>
      <button class="secondary" onclick="loadTemplate()">Laden</button>
      <button class="secondary" onclick="deleteTemplate()">Löschen</button>
    </div>

    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:4px;">
      <button class="secondary" onclick="exportTemplates()">Export</button>
      <button class="secondary" onclick="importTemplates()">Import</button>
    </div>

    <textarea id="tplJson" rows="2" placeholder="JSON Export / Import"></textarea>
  </div>

  <div class="card">
    <h2>Soll- / Istwerte</h2>

    <div class="grid-4-small">
      <div><label>Z1 Pferch Soll</label><input id="z1P_soll"></div>
      <div><label>Z1 Hüll Soll</label><input id="z1H_soll"></div>
      <div><label>Z2 Pferch Soll</label><input id="z2P_soll"></div>
      <div><label>Z2 Hüll Soll</label><input id="z2H_soll"></div>
    </div>

    <div class="grid-4-small">
      <div><label>Z1 Pferch Ist</label><input id="z1P_ist"></div>
      <div><label>Z1 Hüll Ist</label><input id="z1H_ist"></div>
      <div><label>Z2 Pferch Ist</label><input id="z2P_ist"></div>
      <div><label>Z2 Hüll Ist</label><input id="z2H_ist"></div>
    </div>

    <div class="grid-2-small">
      <div><label>Z1 Position</label><input id="z1_pos"></div>
      <div><label>Z2 Position</label><input id="z2_pos"></div>
    </div>

    <div class="grid-2-small">
      <div><label>Fräserwinkel (Grad)</label><input id="winkel" value="55"></div>
      <div>
        <label>Y-Korrektur Modus</label>
        <div style="display:flex;gap:4px;">
          <button id="yOffBtn" class="y-off y-active" onclick="setYMode(false)">Y AUS</button>
          <button id="yOnBtn" class="y-on" onclick="setYMode(true)">Y EIN</button>
        </div>
        <input id="y_enable" type="hidden" value="0">
      </div>
    </div>
  </div>

  <div class="card">
    <h2>DFQ Istwerte</h2>
    <div class="grid-2-small">
      <div><label>DFQ Datei</label><input id="dfqFile" type="file" accept=".dfq,.txt"></div>
      <div style="display:flex;align-items:flex-end;"><button class="secondary" onclick="parseDFQ()">DFQ laden</button></div>
    </div>
  </div>

  <div class="card">
    <h2>Lernen aus Korrektur</h2>

    <div class="grid-2-small">
      <div><label>Meine Korrektur X (mm)</label><input id="learn_x"></div>
      <div><label>Meine Korrektur Y (mm)</label><input id="learn_y"></div>
    </div>

    <div class="grid-2-small">
      <div><label>Meine Korrektur Z (mm)</label><input id="learn_z"></div>
      <div></div>
    </div>

    <div style="display:flex;gap:6px;">
      <button class="secondary" onclick="saveLearnStart()">Lern-Start speichern</button>
      <button class="secondary" onclick="applyLearning()">Korrektur lernen</button>
    </div>

    <div id="factorStatus" class="info"></div>
  </div>

</div>

<!-- RECHTE SEITE -->
<div>

  <div class="card">
    <h2>Berechnung & Vorschlag</h2>
    <div style="display:flex;gap:6px;margin-bottom:6px;">
      <button onclick="calculate(false)">Berechnen</button>
      <button class="secondary" onclick="exportPDF()">PDF</button>
    </div>
    <pre id="result">Noch keine Berechnung</pre>
  </div>

  <div class="card">
    <h2>Fanuc Wear Vorschlag</h2>
    <pre id="fanucOut">Noch keine Daten</pre>
  </div>

</div>

</div>

<script>
// Zahl mit Komma/Punkt, leere Felder = 0
function F(id){
  const el=document.getElementById(id);
  if(!el) return 0;
  const raw=(el.value||"").toString().replace(",",".");
  const v=parseFloat(raw);
  return isNaN(v)?0:v;
}

/* ---------- Templates ---------- */
function refreshTemplateList(){
  templateSelect.innerHTML="";
  const keys=Object.keys(localStorage).filter(k=>k.startsWith("tpl_"));
  if(keys.length===0){
    const opt=document.createElement("option");
    opt.textContent="Kein Template";
    templateSelect.appendChild(opt);
    return;
  }
  keys.forEach(k=>{
    const d=JSON.parse(localStorage.getItem(k));
    const opt=document.createElement("option");
    opt.value=k;
    opt.textContent=(d.machine_id||"?")+" | "+(d.article_id||k.replace("tpl_",""));
    templateSelect.appendChild(opt);
  });
}
refreshTemplateList();

function saveTemplate(){
  const name=tplName.value.trim();
  if(!name){alert("Name fehlt.");return;}
  const d={
    article_id:article_id.value,
    machine_id:machine_id.value,
    z1P_soll:z1P_soll.value,
    z1H_soll:z1H_soll.value,
    z2P_soll:z2P_soll.value,
    z2H_soll:z2H_soll.value,
    z1_pos:z1_pos.value,
    z2_pos:z2_pos.value,
    winkel:winkel.value,
    y_enable:y_enable.value
  };
  localStorage.setItem("tpl_"+name,JSON.stringify(d));
  refreshTemplateList();
}

function loadTemplate(){
  const key=templateSelect.value;
  if(!key.startsWith("tpl_"))return;
  const d=JSON.parse(localStorage.getItem(key));
  Object.keys(d).forEach(k=>{
    const el=document.getElementById(k);
    if(!el) return;
    if(k==="y_enable"){
      setYMode(d[k]=="1");
    }else{
      el.value=d[k];
    }
  });
}

function deleteTemplate(){
  const key=templateSelect.value;
  if(key.startsWith("tpl_")){
    localStorage.removeItem(key);
    refreshTemplateList();
  }
}

function exportTemplates(){
  const all={};
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith("tpl_")){
      all[k.replace("tpl_","")] = JSON.parse(localStorage.getItem(k));
    }
  });
  tplJson.value=JSON.stringify(all,null,2);
}

function importTemplates(){
  try{
    const obj=JSON.parse(tplJson.value);
    Object.keys(obj).forEach(k=>{
      localStorage.setItem("tpl_"+k,JSON.stringify(obj[k]));
    });
    refreshTemplateList();
    alert("Templates importiert");
  }catch(e){
    alert("Import Fehler");
  }
}

/* ---------- Lernmodell ---------- */
function getModelKey(){
  const m=(machine_id.value||"").trim();
  const a=(article_id.value||"").trim();
  if(!m && !a) return "global";
  return m+"|"+a;
}

function loadSamples(key){
  try{
    const s=localStorage.getItem("samples_"+key);
    if(!s) return [];
    return JSON.parse(s);
  }catch(e){return [];}
}

function saveSamples(key,arr){
  if(arr.length>300) arr=arr.slice(arr.length-300);
  localStorage.setItem("samples_"+key,JSON.stringify(arr));
}

/* ---------- Y-Modus ---------- */
function setYMode(on){
  const offBtn=document.getElementById("yOffBtn");
  const onBtn=document.getElementById("yOnBtn");
  const yVal=document.getElementById("y_enable");
  if(on){
    yVal.value="1";
    onBtn.classList.add("y-active");
    offBtn.classList.remove("y-active");
  }else{
    yVal.value="0";
    offBtn.classList.add("y-active");
    onBtn.classList.remove("y-active");
  }
}
setYMode(false);

/* ---------- DFQ Laden ---------- */
function parseDFQ(){
  const file=dfqFile.files[0];
  if(!file){alert("DFQ wählen.");return;}
  const reader=new FileReader();
  reader.onload=()=>{
    const lines=reader.result.split(/\r?\n/);
    const v={};
    lines.forEach(l=>{
      const m=l.match(/K0001\/(\d+)\s+([\d\.]+)/);
      if(m){v[m[1]]=parseFloat(m[2]);}
    });

    if(v["1"]!=null) z1P_ist.value=v["1"].toFixed(3);
    if(v["2"]!=null) z1H_ist.value=v["2"].toFixed(3);
    if(v["3"]!=null) z2P_ist.value=v["3"].toFixed(3);
    if(v["4"]!=null) z2H_ist.value=v["4"].toFixed(3);

    // neue DFQ → Vorschläge in X/Y/Z immer überschreiben
    calculate(true);
  };
  reader.readAsText(file);
}

/* ---------- Lernen ---------- */
let learnStart=null;

function saveLearnStart(){
  learnStart={
    z1Ps:F("z1P_soll"),
    z1Hs:F("z1H_soll"),
    z2Ps:F("z2P_soll"),
    z2Hs:F("z2H_soll"),
    z1Pi:F("z1P_ist"),
    z1Hi:F("z1H_ist"),
    z2Pi:F("z2P_ist"),
    z2Hi:F("z2H_ist")
  };
  factorStatus.textContent="Lern-Start gespeichert.";
}

function applyLearning(){
  if(!learnStart){
    factorStatus.textContent="Bitte zuerst Lern-Start speichern.";
    return;
  }
  const lx=F("learn_x");
  const ly=F("learn_y");
  const lz=F("learn_z");

  const s=learnStart;

  const D1s=(s.z1Ps+s.z1Hs)/2;
  const D2s=(s.z2Ps+s.z2Hs)/2;
  const D1i=(s.z1Pi+s.z1Hi)/2;
  const D2i=(s.z2Pi+s.z2Hi)/2;

  const dMean=((D1i-D1s)+(D2i-D2s))/2;
  const dDiff=(D2i-D2s)-(D1i-D1s);

  const pair2Ist=s.z2Hi-s.z2Pi;
  const pair2Soll=s.z2Hs-s.z2Ps;
  const dPair=pair2Ist-pair2Soll;

  const key=getModelKey();
  let samples=loadSamples(key);

  samples.push({
    dMean:dMean,
    dDiff:dDiff,
    dPair:dPair,
    offX:lx,
    offY:ly,
    offZ:lz
  });

  saveSamples(key,samples);

  factorStatus.textContent="Korrektur gelernt.";
}

/* ---------- Gauss Filter ---------- */
function gaussGain(samples, curMean, curDiff, curPair, axis){
  if(samples.length===0) return null;

  // engeres Sigma → lernt schneller
  const sigmaMean=0.03;
  const sigmaDiff=0.03;
  const sigmaPair=0.03;
  const invM=1/(sigmaMean*sigmaMean);
  const invD=1/(sigmaDiff*sigmaDiff);
  const invP=1/(sigmaPair*sigmaPair);

  let sum_wx2=0;
  let sum_wxy=0;

  for(const s of samples){
    const dM=curMean-(s.dMean||0);
    const dD=curDiff-(s.dDiff||0);
    const dP=curPair-(s.dPair||0);
    const dist2=dM*dM*invM + dD*dD*invD + dP*dP*invP;
    const w=Math.exp(-0.5*dist2);

    let x,y;
    if(axis==="X"){
      x=s.dMean||0;          // X reagiert auf Mittelabweichung
      y=s.offX||0;
    }else if(axis==="Z"){
      x=(s.dMean||0)+(s.dDiff||0); // Z reagiert auf Kombination
      y=s.offZ||0;
    }else{
      x=s.dPair||0;          // Y reagiert auf Paarabweichung
      y=s.offY||0;
    }

    sum_wx2+=w*x*x;
    sum_wxy+=w*x*y;
  }

  if(Math.abs(sum_wx2)<1e-6) return null;
  return sum_wxy/sum_wx2;
}

/* ---------- Offset-Vorschläge ---------- */
function suggestOffset(samples, curMean, curDiff, curPair, feature, axis, baseGain, yEnabled){
  if(axis==="Y" && !yEnabled) return 0;

  let gain=null;
  if(samples.length>0){
    gain=gaussGain(samples,curMean,curDiff,curPair,axis);
  }
  if(gain==null){
    gain=baseGain;
  }
  return gain*feature;
}

/* ---------- Berechnung ---------- */
// forceOverwrite = true: DFQ geladen → Vorschläge IMMER in Felder schreiben
// forceOverwrite = false: Berechnen → nur leere Felder füllen, manuelle Werte bleiben
function calculate(forceOverwrite){
  const z1Ps=F("z1P_soll"), z1Hs=F("z1H_soll");
  const z2Ps=F("z2P_soll"), z2Hs=F("z2H_soll");
  const z1Pi=F("z1P_ist"), z1Hi=F("z1H_ist");
  const z2Pi=F("z2P_ist"), z2Hi=F("z2H_ist");

  const D1s=(z1Ps+z1Hs)/2;
  const D2s=(z2Ps+z2Hs)/2;
  const D1i=(z1Pi+z1Hi)/2;
  const D2i=(z2Pi+z2Hi)/2;

  const dD1=D1i-D1s;
  const dD2=D2i-D2s;

  const dMean=(dD1+dD2)/2;       // mittlere Durchmesserabweichung
  const dDiff=dD2-dD1;           // Unterschied oben/unten
  const pair2Ist=z2Hi-z2Pi;
  const pair2Soll=z2Hs-z2Ps;
  const dPair=pair2Ist-pair2Soll; // Abweichung Hüll–Pferch unten

  const wDeg=F("winkel");
  const tanw=Math.tan(wDeg*Math.PI/180);

  const yEnabled=(document.getElementById("y_enable").value==="1");

  const key=getModelKey();
  const samples=loadSamples(key);

  // Feature-Definitionen (linear, wie echte Maschine reagiert)
  const featX = dMean;
  const featZ = dMean + dDiff;    // Steigung + allgemeiner Fehler
  const featY = dPair;

  // Basis-Gains (werden durch Lernen überschrieben)
  const baseGainX = 1.0;   // X: fast 1:1
  const baseGainZ = 0.6;   // Z: etwas weicher
  const baseGainY = 0.7;   // Y: weicher, nur wenn aktiv

  let offX_sugg = suggestOffset(samples,dMean,dDiff,dPair,featX,"X",baseGainX,yEnabled);
  let offZ_sugg = suggestOffset(samples,dMean,dDiff,dPair,featZ,"Z",baseGainZ,yEnabled);
  let offY_sugg = suggestOffset(samples,dMean,dDiff,dPair,featY,"Y",baseGainY,yEnabled);

  // Fallback, falls alles extrem ist (z.B. keine Winkelinfos)
  if(!isFinite(offZ_sugg)){
    const offZ_geom = Math.abs(tanw)>1e-6 ? -(dDiff/(2*tanw)) : 0;
    offZ_sugg = offZ_geom;
  }

  // Rundung & Deadzone
  function clean(v){
    v=Math.round(v*100)/100;
    if(Math.abs(v)<0.002) return 0;
    return v;
  }
  offX_sugg=clean(offX_sugg);
  offY_sugg=clean(offY_sugg);
  offZ_sugg=clean(offZ_sugg);

  let offX_used, offY_used, offZ_used;

  if(forceOverwrite){
    // DFQ: Vorschlag IMMER in Felder
    learn_x.value=offX_sugg.toFixed(2);
    learn_y.value=offY_sugg.toFixed(2);
    learn_z.value=offZ_sugg.toFixed(2);
    offX_used=offX_sugg;
    offY_used=offY_sugg;
    offZ_used=offZ_sugg;
  }else{
    // Berechnen: leere Felder füllen, manuelle Werte respektieren
    if(learn_x.value.trim()===""){
      learn_x.value=offX_sugg.toFixed(2);
      offX_used=offX_sugg;
    }else{
      offX_used=clean(F("learn_x"));
      learn_x.value=offX_used.toFixed(2);
    }

    if(learn_y.value.trim()===""){
      learn_y.value=offY_sugg.toFixed(2);
      offY_used=offY_sugg;
    }else{
      offY_used=clean(F("learn_y"));
      learn_y.value=offY_used.toFixed(2);
    }

    if(learn_z.value.trim()===""){
      learn_z.value=offZ_sugg.toFixed(2);
      offZ_used=offZ_sugg;
    }else{
      offZ_used=clean(F("learn_z"));
      learn_z.value=offZ_used.toFixed(2);
    }
  }

  const res=
    "ΔD1 (Mitte Z1): "+dD1.toFixed(3)+" mm\n"+
    "ΔD2 (Mitte Z2): "+dD2.toFixed(3)+" mm\n"+
    "ΔDmean: "+dMean.toFixed(3)+" mm\n"+
    "ΔDiff (Z2-Z1): "+dDiff.toFixed(3)+" mm\n"+
    "ΔPair2 (Hüll-Pferch Z2): "+dPair.toFixed(3)+" mm\n\n"+
    "Offsets verwendet (Hundertstel):\n"+
    "X: "+offX_used.toFixed(2)+" mm\n"+
    "Z: "+offZ_used.toFixed(2)+" mm\n"+
    "Y: "+offY_used.toFixed(2)+" mm";

  result.textContent=res;

  fanucOut.textContent=
    "FANUC WEAR (Vorschlag / verwendet)\n"+
    "X: "+offX_used.toFixed(2)+" mm\n"+
    "Z: "+offZ_used.toFixed(2)+" mm\n"+
    "Y: "+offY_used.toFixed(2)+" mm";
}

/* ---------- PDF Export ---------- */
function exportPDF(){
  var doc=new jsPDF();

  doc.setFont("helvetica","bold");
  doc.setFontSize(14);
  doc.text("Gear Offset – Messbericht",10,14);

  doc.setFont("helvetica","normal");
  doc.setFontSize(9);
  doc.text("Datum: "+new Date().toLocaleString(),10,20);
  if(article_id.value) doc.text("Artikel: "+article_id.value,10,26);
  if(machine_id.value) doc.text("Maschine: "+machine_id.value,10,32);

  doc.setFont("helvetica","bold");
  doc.setFontSize(11);
  doc.text("Soll / Ist",10,40);
  doc.line(10,42,200,42);

  let y=48;
  function row(a,b,c){
    doc.text(a.padEnd(12)+" "+(b||"-")+"  "+(c||"-"),10,y);
    y+=5;
  }
  row("Z1 Pferch",z1P_soll.value,z1P_ist.value);
  row("Z1 Hüll",z1H_soll.value,z1H_ist.value);
  row("Z2 Pferch",z2P_soll.value,z2P_ist.value);
  row("Z2 Hüll",z2H_soll.value,z2H_ist.value);

  doc.setFont("helvetica","bold");
  doc.setFontSize(11);
  doc.text("Berechnung / Offsets",10,y+6);
  doc.line(10,y+8,200,y+8);
  y+=14;

  doc.setFont("courier","normal");
  result.textContent.split("\n").forEach(l=>{
    doc.text(l,10,y); y+=5;
  });

  doc.save("gear-offset-report.pdf");
}
</script>

</body>
</html>
